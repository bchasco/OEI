---
title: "BPA Cruise Summary"
author: "OEI working group"
date: "8/17/2021"
output:
  html_document: 
    fig_caption: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(OEI)
library(tidyr)
library(reshape)
library(tidyverse)
library(ggplot2)
library(grid)
library(ggthemes)
```


```{r, echo=FALSE}
myYear <- 2020 #year of interest
uid <- "brandon.chasco"
pwd <- "bchasco"

stationSummary <- getTable(uid=uid
                           ,pwd = pwd
                           ,schemaName = "dbo"
                           ,tableName = "V_salmon_CPUE_by_haul")

stationSummary <- stationSummary[stationSummary$Year==myYear,]

station_melt <- stationSummary %>% melt(id.vars=names(stationSummary)[1:22])
station_melt$CPUE <- 0
station_melt$CPUE[grep("CPUE",station_melt$variable)] <- 1

Catches <- station_melt[station_melt$CPUE==0,]
Ag_Catches <- aggregate(list(total=Catches$value),by=list(group =Catches$variable), sum)
ChinookTotal <- sum(Ag_Catches$total[grep("Chinook",Ag_Catches$group)])
CohoTotal <- sum(Ag_Catches$total[grep("Coho",Ag_Catches$group)])

MayStations <- length(unique(stationSummary$`Station Code`[stationSummary$Month=="May"]))
JuneStations <- length(unique(stationSummary$`Station Code`[stationSummary$Month=="June"]))

ctdSummary <- getTable(uid=uid
                           ,pwd = pwd
                           ,schemaName = "crepo"
                           ,tableName = "CTD Info")
ctdYear <- substr(as.character(myYear),3,4)
ctdSummary <- ctdSummary[substr(ctdSummary$`Station Code`,5,6)==ctdYear,]

planktonSummary <- getTable(uid=uid
                           ,pwd = pwd
                           ,schemaName = "crepo"
                           ,tableName = "BPA HM_Plankton Length Data")
planktonYear <- substr(as.character(myYear),3,4)
planktonSummary <- planktonSummary[substr(planktonSummary$`Station Code`,5,6)==planktonYear,]


strYear <- substr(as.character(myYear),3,4)

trawl <- getTable(uid=uid,
                  pwd=pwd,
                  schemaName = "crepo",
                  tableName = "Trawl Info")
trawl <- trawl[substr(trawl$`Station Code`,5,6)==strYear,]

contents <- getTable(uid=uid,
                          pwd=pwd,
                          schemaName = "crepo",
                     tableName = "Trawl Contents")
contents <- contents[contents$`Station Code`%in%trawl$`Station Code`,]
Chinook <- contents[grep("Chinook",contents$`Common Name`),]
Coho <- contents[grep("Coho",contents$`Common Name`),]
Steelhead <- contents[grep("Steelhead",contents$`Common Name`),]
Chum <- contents[grep("Chum",contents$`Common Name`),]
Sockeye <- contents[grep("Sockeye",contents$`Common Name`),]
Cutthroat <- contents[grep("Cutthroat",contents$`Common Name`),]
Salmon <- contents[grep("salmon",contents$`Common Name`),]

intNames <- c("one", "two", "three", "four", "five", "six", "seven", "eight", "nine", "ten")

Ch_perc_sub <- sum(Chinook$Count[Chinook$Age_ClassByLength!="subadult/adult"])/sum(Chinook$Count)
Co_perc_sub <- sum(Coho$Count[Coho$Age_ClassByLength!="subadult/adult"])/sum(Coho$Count)
St_perc_sub <- sum(Steelhead$Count[Steelhead$Age_ClassByLength!="subadult/adult"])/sum(Steelhead$Count)
Chum_perc_sub <- sum(Chum$Count[Chum$Age_ClassByLength!="subadult/adult"])/sum(Chum$Count)
So_perc_sub <- sum(Sockeye$Count[Sockeye$Age_ClassByLength!="subadult/adult"])/sum(Sockeye$Count)
Cu_perc_sub <- sum(Cutthroat$Count[Cutthroat$Age_ClassByLength!="subadult/adult"])/sum(Cutthroat$Count)



```

## Summary for June, `r myYear`

We sampled `r length(unique(c(stationSummary$'Station Code',planktonSummary$'Station Code',ctdSummary$'Station Code')))` station locations during the `r myYear` June survey, including `r nrow(trawl)` trawls, xx plankton tows, xx bongo tows, and `r nrow(ctdSummary)` CTD casts.  A total of `r sum(Chinook$Count)` Chinook and `r sum(Coho$Count)` Coho were captured, representing `r round((sum(Chinook$Count)+sum(Coho$Count))/sum(Salmon$Count),3)*100`% the total salmonid catch numerically. In addition, `r ifelse(nrow(Chum)<=10,intNames[nrow(Chum)],nrow(Chum))` Chum salmon, `r ifelse(nrow(Sockeye)<=10,intNames[nrow(Sockeye)],nrow(Sockeye))` Sockeye salmon,  `r ifelse(nrow(Cutthroat)<=10,intNames[nrow(Cutthroat)],nrow(Cutthroat))` cutthroat trout, and `r ifelse(nrow(Steelhead)<=10,intNames[nrow(Steelhead)],nrow(Steelhead))` steelhead were captured. The majority of salmon caught were juveniles: `r round(Ch_perc_sub,3)*100`% of the Chinook salmon (those ≤ 450 mm FL), `r round(Co_perc_sub,3)*100`% of the coho salmon (those ≤ 330 mm FL), `r round(St_perc_sub,3)*100`% of the steelhead, and `r round(Chum_perc_sub,2)*100`% of the chum salmon, `r round(So_perc_sub,3)*100`% sockeye salmon and `r round(Cu_perc_sub,3)*100` cutthroat (those of the latter species ≤ 350 mm FL).

```{r summaryStationPlot, echo=FALSE, fig.width=10,fig.height=11, fig.cap="Stations sampled in `r myYear`."}

contents$effort <- trawl$`Trawling distance (km)`[match(contents$`Station Code`,trawl$`Station Code`)]

transectID <- getTable(uid=uid,
                       pwd=pwd,
                       schemaName = "crepo",
                       tableName = "Transect Codes")
mySalmonids <- c("Chinook salmon", "Chum salmon", "Coho salmon", "Sockeye salmon", "Cutthroat trout", "Steelhead")

salmon_contents <- contents[contents$`Common Name`%in%mySalmonids,]

salmon_contents$transect <- transectID$`Transect Name`[match(substr(salmon_contents$'Station Code',7,8),transectID$`Transect Code`)]

salmon_contents$lat <- trawl$`Start Lat (decimal degrees)`[match(salmon_contents$`Station Code`,trawl$`Station Code`)]
salmon_contents$long <- trawl$`Start Long (decimal degrees)`[match(salmon_contents$`Station Code`,trawl$`Station Code`)]

sub_yrlg <- salmon_contents[salmon_contents$Age_ClassByLength=='subyearling',]
sub_yrlg_ag_count <- aggregate(list(total=sub_yrlg$Count), by = list(sp = sub_yrlg$`Common Name`, station = sub_yrlg$`Station Code`), sum)
sub_yrlg_ag_count$effort <- trawl$`Trawling distance (km)`[match(sub_yrlg_ag_count$station,trawl$`Station Code`)]
sub_yrlg_ag_count$CPUE <- sub_yrlg_ag_count$total/sub_yrlg_ag_count$effort
sub_yrlg_ag_count$transect <- transectID$`Transect Name`[match(substr(sub_yrlg_ag_count$station,7,8),transectID$`Transect Code`)]
sub_yrlg_ag_count <- sub_yrlg_ag_count[order(-sub_yrlg_ag_count$CPUE),]

yrlg <- salmon_contents[salmon_contents$Age_ClassByLength=='yearling' | salmon_contents$Age_ClassByLength=='juvenile' | salmon_contents$Age_ClassByLength=='mixed age juvenile',]
yrlg_ag_count <- aggregate(list(total=yrlg$Count), by = list(sp = yrlg$`Common Name`, station = yrlg$`Station Code`, age=yrlg$Age_ClassByLength), sum)
yrlg_ag_count$effort <- trawl$`Trawling distance (km)`[match(yrlg_ag_count$station,trawl$`Station Code`)]
yrlg_ag_count$CPUE <- yrlg_ag_count$total/yrlg_ag_count$effort
yrlg_ag_count$transect <- transectID$`Transect Name`[match(substr(yrlg_ag_count$station,7,8),transectID$`Transect Code`)]
yrlg_ag_count <- yrlg_ag_count[order(-yrlg_ag_count$CPUE),]

ch_yrlg_ag_count <- yrlg_ag_count[yrlg_ag_count$sp=="Chinook salmon" & yrlg_ag_count$age=="yearling",]
ch_mix_ag_count <- yrlg_ag_count[yrlg_ag_count$sp=="Chinook salmon" & yrlg_ag_count$age=="mixed age juvenile",]
co_yrlg_ag_count <- yrlg_ag_count[yrlg_ag_count$sp=="Coho salmon" & yrlg_ag_count$age=="yearling",]

chum_yrlg_ag_count <- yrlg_ag_count[yrlg_ag_count$sp=="Chum salmon",]
so_yrlg_ag_count <- yrlg_ag_count[yrlg_ag_count$sp=="Sockeye salmon",]
cu_yrlg_ag_count <- yrlg_ag_count[yrlg_ag_count$sp=="Cutthroat trout",]
st_yrlg_ag_count <- yrlg_ag_count[yrlg_ag_count$sp=="Steelhead",]

juvNames <- unique(paste(salmon_contents$`Common Name`,salmon_contents$Age_ClassByLength))
juvNames <- juvNames[!grepl("adult",juvNames)]
salmon_contents$variable <- paste(salmon_contents$`Common Name`,salmon_contents$Age_ClassByLength)

salmon_ag <- aggregate(list(total = salmon_contents$Count), by = list(station=salmon_contents$`Station Code`, variable=salmon_contents$variable, lat = salmon_contents$lat, long = salmon_contents$long), sum)
salmon_ag$effort <- trawl$`Trawling distance (km)`[match(salmon_ag$station,trawl$`Station Code`)]
salmon_ag$CPUE <- salmon_ag$total/salmon_ag$effort  

map <- map_data("state")
mapdata <- map[map$region%in%c("oregon", "washington"),]
variable <- rep(juvNames, each=nrow(mapdata))
mapdata <- cbind(do.call("rbind", replicate(length(juvNames), mapdata, simplify = FALSE)),variable)


S <- ggplot(data=mapdata) +
  geom_polygon(aes(x=long, y=lat), fill="grey") +
  coord_map(xlim=c(-125.5,-123.0),
  ylim=c(44.5,48.5)) +
  geom_point(data=salmon_ag[salmon_ag$CPUE>0 & !grepl("adult",salmon_ag$variable),], aes(x = long, y=lat, size=CPUE), pch=1, inherit.aes = FALSE) +
  facet_wrap(~variable, ncol=4) +
  theme_bw() + theme(panel.border = element_blank(), panel.grid.major = element_blank(),
panel.grid.minor = element_blank(), axis.line = element_line(colour = "black"))
  # theme(legend.position = "none")
#   
# 
print(S)

```

  Subyearling Chinook salmon (≤ 140 mm FL) were most abundant along the `r sub_yrlg_ag_count$transect[1]` (`r round(sub_yrlg_ag_count$CPUE[1],1)` #/km2) and `r sub_yrlg_ag_count$transect[2]` (`r round(sub_yrlg_ag_count$CPUE[2],1)` #/km2) transects (Fig. 2).  Yearling (141–280 mm FL) and mixed-age juvenile Chinook salmon (281–450 mm FL) were most abundant at the `r ch_yrlg_ag_count$transect[1]` transect (`r round(ch_yrlg_ag_count$CPUE[1],1)` #/km2)  and `r ch_mix_ag_count$transect[1]` (`r round(ch_mix_ag_count$CPUE[1],1)` #/km2) transect, respectively.  Yearling coho salmon were captured on all transects, but the highest CPUE (`r round(co_yrlg_ag_count$CPUE[1],1)` #/km2) was found at `r co_yrlg_ag_count$transect[1]`.  Densities of Sockeye salmon (`r round(so_yrlg_ag_count$CPUE[1],1)` #/km2) and Chum salmon (`r round(chum_yrlg_ag_count$CPUE[1],1)` #/km2) were lower than Chinook and Coho, with the highest catches associated with `r so_yrlg_ag_count$transect[1]` and `r chum_yrlg_ag_count$transect[1]`, respectively. Similarly, low densities of juvenile steelhead `r round(st_yrlg_ag_count$CPUE[1],1)` #/km2) and cutthroat trout (`r round(cu_yrlg_ag_count$CPUE[1],1)` #/km2) were observed, with peak catches occuring at `r st_yrlg_ag_count$transect[1]` and `r cu_yrlg_ag_count$transect[1]`, respectively (Fig. 2).
\ref{fig:summaryStationPlot}